version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.6.3-stretch-node
    executor: ruby/default
    steps:
      - checkout
      - run:
          name: Force Bundler Version
          command: |
            sudo gem update --system
            echo 'export BUNDLER_VERSION=$(cat Gemfile.lock | tail -1 | tr -d " ")' >> $BASH_ENV
            source $BASH_ENV
            gem install bundler 


  test:
      docker:
        - image: circleci/ruby:2.6.3-stretch-node
      executor: ruby/default
      steps:
      - checkout
      - run:
          name: Update bundler
          command: gem install bundler:2.1.4
      - run:
          name: Run bundler
          command: bundle install
      - run: echo "this is the test job"
      - run:
          name: DB migrate
          command: rails rake db:migrate
      - run:
          name: RSpec
          command: |
            bundle exec rspec --profile 10 \
                              --format progress

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - build
      - test
